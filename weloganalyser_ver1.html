<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>WE Toolkit - Log Analyser</title>
    <link rel="stylesheet" href="css/log-analyser.css" type="text/css" media="all" />
    <script src="js/jquery/jquery-1.10.2.min.js"></script>
    <script src="js/common.js"></script>
    <script src="js/highcharts/highcharts.js"></script>
    <script src="js/highcharts/modules/exporting.js"></script>
</head>

<body>
    <div id="nav"><a href="index.html">Home</a>
    </div>
    <div id="drop_zone" class="drop-zone">To analyse WE combat logs, drop 'em here to start ...</div>
    <div id="debug"></div>
    <div id="output">
        <div id="combatContainer" class="list">
            <div id="combatTitle" class="list-header">Combats</div>
            <input type="hidden" class="list-hidden" val="0" />
            <div id="combatList" class="list-items">
                <!-- <div id="combat" class="list-item"> ... -->
            </div>
        </div>
        <div id="sourceContainer" class="list">
            <div id="sourceTitle" class="list-header">Sources</div>
            <input type="hidden" class="list-hidden" val="0" />
            <div id="sourceList" class="list-items">
                <!-- <div id="source" class="list-item"> ... -->
            </div>
        </div>
        <!--div id="targetContainer" class="list">
            <div id="targetTitle" class="list-header">Targets</div>
            <input type="hidden" class="list-hidden" val="0" />
            <div id="targetList" class="list-items">
                <!-- <div id="source" class="list-item"> ... 
            </div>
        </div-->
    </div>

    <script>	
		// collapse lists
		$(".list-header").click(function () {
			var obj = $(this).siblings(".list-items");
			var flag = $(this).siblings(".list-hidden");
			var curHeight = obj.height();
			obj.css('height', 'auto');
			var autoHeight = obj.height();
			if (flag.val() == 0) {
				obj.height(curHeight).animate({height: 0}, 300);
				flag.val(1);
			} else {
				obj.height(curHeight).animate({height: autoHeight}, 300);
				flag.val(0);
			}
		});
	
        // Handle drag and drop events with jQuery
        var obj = $("#drop_zone");
        obj.on('dragenter', function (e) {
            e.stopPropagation();
            e.preventDefault();
            $(this).addClass("ondrop");
        });
        obj.on('dragover', function (e) {
            e.stopPropagation();
            e.preventDefault();
        });

         // If the files are dropped outside the div, file is opened in the browser window. To avoid that we can prevent 'drop' event on document.
        $(document).on('dragenter', function (e) {
            e.stopPropagation();
            e.preventDefault();
        });
        $(document).on('dragover', function (e) {
            e.stopPropagation();
            e.preventDefault();
            obj.removeClass("ondrop");
        });
        $(document).on('drop', function (e) {
            e.stopPropagation();
            e.preventDefault();
        });

        var damages = [], heals = [], casts = [], combats = [];

        var sources = [];
        var selectedSources = [];
        var selectedCombat = "";
        var combatFlag = "";
		var combatOriginal = [];

		$.pushDistinct = function (arr, tag, dat) {
			if (arr[tag] == null) {
				arr[tag] = [];
			}
			if ($.inArray(dat, arr[tag]) == -1) {
				arr[tag].push(dat);
			}
		}

        obj.on('drop', function (e) {
            $(this).removeClass("ondrop");
            e.preventDefault();
			
			var files = e.originalEvent.dataTransfer.files;
			
			for (var i = 0; i < files.length; i++) {
				var reader = new FileReader();
				reader.onload = function (e) {
					// get rid of all jass shit
					var cleanContent = e.target.result.replace(/function PreloadFiles takes nothing returns nothing/, "");
					cleanContent = cleanContent.replace(/call Preload\( \"/g, "");
					cleanContent = cleanContent.replace(/\" \)/g, "");
					cleanContent = cleanContent.replace(/call PreloadEnd\(.*/g, "");
					cleanContent = cleanContent.replace(/endfunction/g, "");
					
					//$("#debug").html(cleanContent);

					// start parse json
					$.each($.parseJSON(cleanContent), function (i) {
						if (this[0] == "damage") {
							damages.push(this);
							$.pushDistinct(sources, this[13], this[2]);
							$.pushDistinct(sources, this[14], this[3]);
						} else if (this[0] == "heal") {
							heals.push(this);
							$.pushDistinct(sources, this[8], this[2]);
							$.pushDistinct(sources, this[9], this[3]);
						} else if (this[0] == "cast") {
							casts.push(this);
						} else if (this[0] == "combat") {
							combatOriginal.push(this);
						}
					});	

				};

				reader.readAsText(files[i]);	
							
			}
		
			$(this).addClass("fakeProgress");
			setTimeout(function () {
				$.sort2DArrayByIndexAsc(combatOriginal, 1);
				$.sort2DArrayByIndexAsc(damages, 1);
				//console.log(damages);
				$.sort2DArrayByIndexAsc(heals, 1);		
				
				$.each(combatOriginal, function() {
					if (combatFlag == "") {
						combatFlag = this[1];
					} else {
						combats.push(combatFlag + "-" + this[1]);
						combatFlag = "";
					}
				});
	
			    var str = "";
				$.each(combats, function (i) {
					var timeStamps = this.split("-");
					var interval = (parseFloat(timeStamps[1]) - parseFloat(timeStamps[0])).toFixed(2);
					str += "<div id=\"combat\" class=\"list-item"+(interval>60.0?" long-battle":"")+"\">" + this + " (" + interval + ")</div>";
				});
				$("#combatList").html(str);
//						console.log("good");
	
				str = "";
				if ("boss" in sources) {
					$.each(sources.boss, function () {
						str += "<div id=\"source\" class=\"list-item boss\">" + this + "</div>";            
					});
				}
				if ("tank" in sources) {
					$.each(sources.tank, function () {
						str += "<div id=\"source\" class=\"list-item tank\">" + this + "</div>";            
					});
				}
				if ("healer" in sources) {
					$.each(sources.healer, function () {
						str += "<div id=\"source\" class=\"list-item healer\">" + this + "</div>";            
					});
				}				
				if ("dps" in sources) {
					$.each(sources.dps, function () {
						str += "<div id=\"source\" class=\"list-item dps\">" + this + "</div>";            
					});
				}
				if ("minion" in sources) {
					$.each(sources.minion, function () {
						str += "<div id=\"source\" class=\"list-item minion\">" + this + "</div>";            
					});
				}
				if ("creep" in sources) {
					$.each(sources.creep, function () {
						str += "<div id=\"source\" class=\"list-item creep\">" + this + "</div>";            
					});
				}
				$("#sourceList").html(str);
			}, 500);
        });

        $("#combatList").on('click', '#combat', function () {			
            selectedCombat = $(this).text();
            $(this).siblings().removeClass("selected");
            $(this).addClass("selected");
        });

        $("#sourceList").on('click', '#source', function () {
            if ($.inArray($(this).text(), selectedSources) == -1) {
                $(this).addClass("selected");
                selectedSources.push($(this).text());
            } else {
                $(this).removeClass("selected");
                selectedSources.splice($.inArray($(this).text(), selectedSources), 1);
            }
        });
    </script>

    <div>
        <div id="btnFast" class="button">View</div>
        <div id="btnDPS" class="button">DPS</div>
        <div id="btnDTPS" class="button">DTPS</div>
        <div id="btnHPS" class="button">HPS</div>
        <div id="btnDamage" class="button">Damage</div>
        <div id="btnDamageTaken" class="button">D Taken</div>
        <div id="btnHeal" class="button">Heal</div>
        <div id="btnCast" class="button">Cast</div>
    </div>

    <div id="message" class="notification"></div>

    <div id="chartResult">
    	<!--div>Overview</div-->
        <div id="comprehensiveComparison" class="achart"></div>
        <div id="comprehensiveComparison1" class="achart"></div>
        <div id="lineComparison" class="achart"></div>
        <div id="pieComparison" class="achart"></div>
    </div>

    <script>
        var TIME_INTERVAL = 5.0;
		var $bodyroot = $('html, body');

        $.errMsg = function (text) {
            $("#message").addClass("notify");
            $("#message").html(text);
            setTimeout(function () {
                $("#message").removeClass("notify");
            }, 3000);
        }
		
		//======================================
		// clicked *** View ***
		//======================================
		
		$("#btnFast").click(function () {
            if (selectedCombat == "") {
                $.errMsg("Select a combat first my friend.");
            } else {
                var timeStamps = selectedCombat.split("-");

                // good to go!
                var options = {
					chart: {
						type: 'bar'
					},
					title: {
						text: 'Damage Overview'
					},
					subtitle: {
						text: 'Combat: ' + timeStamps[0] + ' - ' + timeStamps[1]
					},
					colors: [
						'#da532c'
					],
					xAxis: {
						type: 'category',
						labels: {
							style: {
								fontSize: '13px',
								fontFamily: 'Verdana, sans-serif'
							}
						}
					},
					yAxis: {
						min: 0,
						title: {
							text: 'Damages done'
						}
					},
					legend: {
						enabled: false
					},
					tooltip: {
						pointFormat: 'Total damage: <b>{point.y:.1f}</b>',
					},
					series: []
				};
				
				var options1 = {
					chart: {
						type: 'bar'
					},
					title: {
						text: 'Healing Overview'
					},
					subtitle: {
						text: 'Combat: ' + timeStamps[0] + ' - ' + timeStamps[1]
					},
					colors: [
						'#ff0097', '#00a300'
					],
					xAxis: {
						categories: [] // 1d array names sorted ['不会杀生', '断章', '兄弟同心']
					},
					yAxis: {
						min: 0,
						title: {
							text: 'Total healings'
						}
					},
					legend: {
						enabled: true,
		                reversed: true
					},
					plotOptions: {
						series: {
							stacking: 'normal'
						}
					},
					series: [] 
					//{name: 'Overflow', data: [200, 189, 223]}, {name: 'Effect',data: [100, 150, 120]}
					// 2, overflow first. data = 1d array
				};

                var tm0 = parseFloat(timeStamps[0]);
                var tm1 = parseFloat(timeStamps[1]);				
				var allies = [];
				if ("tank" in sources) {
					$.merge(allies, sources['tank']);
				}
				if ("healer" in sources) {
					$.merge(allies, sources['healer']);
				}
				if ("dps" in sources) {
					$.merge(allies, sources['dps']);
				}
				if ("minion" in sources) {
					$.merge(allies, sources['minion']);
				}

				var dmgseries = [];
				var healseries = [];
                $.each(allies, function (i) {
                    var totdmg = 0.0;
                    $.each(damages, function () {
                        if (this[2] == allies[i]) {
                            var tmnow = parseFloat(this[1]);
                            if (tm0 <= tmnow && tmnow <= tm1) {
                                totdmg += parseFloat(this[5]);
                            }
                        }
                    });
					var datase = [];
                    datase.push(allies[i]);
                    datase.push(totdmg);
					dmgseries.push(datase);
					
					// healings
					var toteffect = 0.0;
					var totoverflow = 0.0;
                    $.each(heals, function () {
                        if (this[2] == allies[i]) {
                            var tmnow = parseFloat(this[1]);
                            if (tm0 <= tmnow && tmnow <= tm1) {
                                toteffect += parseFloat(this[5]);
                                totoverflow += parseFloat(this[6]);
                            }
                        }
                    });
					var datases = [];
                    datases.push(allies[i]);
                    datases.push(toteffect + totoverflow);
                    datases.push(totoverflow);
                    datases.push(toteffect);
					healseries.push(datases);
					
                });
				
				// total damage
				$.sort2DArrayByIndex(dmgseries, 1);				
				options.series.push({
					name: "Damages",
					data: dmgseries
				});
                $("#comprehensiveComparison").highcharts(options);
				
				// total heal
				$.sort2DArrayByIndex(healseries, 1);
				var overflows = [];
				var effectivs = [];
				$.each(healseries, function() {
					options1.xAxis.categories.push(this[0]);
					overflows.push(this[2]);
					effectivs.push(this[3]);
				});
				options1.series.push({
					name: "Overflow",
					data: overflows
				});
				options1.series.push({
					name: "Effective",
					data: effectivs
				});
                $("#comprehensiveComparison1").highcharts(options1);			
				
				$bodyroot.animate({
					scrollTop: $("#comprehensiveComparison").offset().top
				}, 500);
            }
        });		

		//======================================
		// clicked *** DPS & DTPS & HPS ***
		//======================================
		
        $("#btnDPS").click(function () {
            if (selectedCombat == "") {
                $.errMsg("Select a combat mate.");
            } else {
                var timeStamps = selectedCombat.split("-");
                var tm0 = parseFloat(timeStamps[0]);
                var tm1 = parseFloat(timeStamps[1]);

                // good to go!
                var options = {
                    title: {
                        text: 'Damage Per Second',
                        x: -20 //center
                    },
                    subtitle: {
                        text: 'Combat: ' + tm0 + ' - ' + tm1,
                        x: -20
                    },
                    xAxis: {
                        categories: []
                            // push categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
                    },
                    yAxis: {
                        title: {
                            text: 'DPS'
                        },
                        plotLines: [{
                            value: 0,
                            width: 1,
                            color: '#808080'
                        }]
                    },
                    tooltip: {
                        valueSuffix: ''
                    },
                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'middle',
                        borderWidth: 0
                    },
                    series: []
                };

				var serieses = [];
				var tots = [];
				$.each(selectedSources, function () {
					serieses.push([]);
					tots.push(0);
				});				
                var blocks = Math.ceil((tm1 - tm0) / TIME_INTERVAL) + 1;
				var windex = 0;
                for (var i = 0; i < blocks; i++) {
					var tmmax = (i + 1) * TIME_INTERVAL;
                    options.xAxis.categories.push(tmmax);
					while (windex < damages.length && parseFloat(damages[windex][1]) - tm0 < tmmax) {
						if (tm0 < parseFloat(damages[windex][1])) {
							var index = $.inArray(damages[windex][2], selectedSources);
							if (index != -1) {
								tots[index] += parseFloat(damages[windex][5]);
							}
						}
						windex ++;	
					}
					$.each(selectedSources, function (i) {
						serieses[i].push(tots[i] / tmmax);
					});	
                }
				$.each(selectedSources, function (i) {
					options.series.push({
						name: selectedSources[i],
						data: serieses[i]
					});
				});	

				
                $("#lineComparison").highcharts(options);
				$bodyroot.animate({
					scrollTop: $("#lineComparison").offset().top
				}, 500);
            }
        });
		
$("#btnDTPS").click(function(){if(selectedCombat==""){$.errMsg("You forgot to select a combat buddy.")}else{var timeStamps=selectedCombat.split("-");var tm0=parseFloat(timeStamps[0]);var tm1=parseFloat(timeStamps[1]);var options={title:{text:'Damage Taken Per Second',x:-20},subtitle:{text:'Combat: '+tm0+' - '+tm1,x:-20},xAxis:{categories:[]},yAxis:{title:{text:'Damage Taken Per Second'},plotLines:[{value:0,width:1,color:'#808080'}]},tooltip:{valueSuffix:''},legend:{layout:'vertical',align:'right',verticalAlign:'middle',borderWidth:0},series:[]};var serieses=[];var tots=[];$.each(selectedSources,function(){serieses.push([]);tots.push(0)});var blocks=Math.ceil((tm1-tm0)/TIME_INTERVAL)+1;var windex=0;for(var i=0;i<blocks;i++){var tmmax=(i+1)*TIME_INTERVAL;options.xAxis.categories.push(tmmax);while(windex<damages.length&&parseFloat(damages[windex][1])-tm0<tmmax){if(tm0<parseFloat(damages[windex][1])){var index=$.inArray(damages[windex][3],selectedSources);if(index!=-1){tots[index]+=parseFloat(damages[windex][5])}}windex++}$.each(selectedSources,function(i){serieses[i].push(tots[i]/tmmax)})}$.each(selectedSources,function(i){options.series.push({name:selectedSources[i],data:serieses[i]})});$("#lineComparison").highcharts(options);$bodyroot.animate({scrollTop:$("#lineComparison").offset().top},500)}});
		
$("#btnHPS").click(function(){if(selectedCombat==""){$.errMsg("Select a combat first, then do this!")}else{var timeStamps=selectedCombat.split("-");var tm0=parseFloat(timeStamps[0]);var tm1=parseFloat(timeStamps[1]);var options={title:{text:'Healing Per Second',x:-20},subtitle:{text:'Combat: '+tm0+' - '+tm1,x:-20},xAxis:{categories:[]},yAxis:{title:{text:'HPS'},plotLines:[{value:0,width:1,color:'#808080'}]},tooltip:{valueSuffix:''},legend:{layout:'vertical',align:'right',verticalAlign:'middle',borderWidth:0},series:[]};var serieses=[];var tots=[];$.each(selectedSources,function(){serieses.push([]);tots.push(0)});var blocks=Math.ceil((tm1-tm0)/TIME_INTERVAL)+1;var windex=0;for(var i=0;i<blocks;i++){var tmmax=(i+1)*TIME_INTERVAL;options.xAxis.categories.push(tmmax);while(windex<heals.length&&parseFloat(heals[windex][1])-tm0<tmmax){if(tm0<parseFloat(heals[windex][1])){var index=$.inArray(heals[windex][2],selectedSources);if(index!=-1){tots[index]+=parseFloat(heals[windex][5])+parseFloat(heals[windex][6])}}windex++}$.each(selectedSources,function(i){serieses[i].push(tots[i]/tmmax)})}$.each(selectedSources,function(i){options.series.push({name:selectedSources[i],data:serieses[i]})});$("#lineComparison").highcharts(options);$bodyroot.animate({scrollTop:$("#lineComparison").offset().top},500)}});
		
		//================================================
		// clicked *** damage / Damage Taken / Heal ***
		//================================================
		
		$.pieSeriesArrayAdd = function (arr, inindex, val) {
			var found = 0;
			$.each(arr, function (i) {
				if (arr[i][0] == inindex) {
					found = 1;
					arr[i][1] += val;
				}
			});
			if (found == 0) {
				arr.push([inindex, val]);
			}
		}

        $("#btnDamage").click(function () {
            if (selectedCombat == "") {
                $.errMsg("Select a combat mate.");
            } else if (selectedSources.length != 1) {
                $.errMsg("Choose one and only one source dude!");
            } else {
                var timeStamps = selectedCombat.split("-");		
                var tm0 = parseFloat(timeStamps[0]);
                var tm1 = parseFloat(timeStamps[1]);		
				var forUnit = selectedSources[0];

                // good to go!
                var options = {
                    chart: {
                        plotBackgroundColor: null,
                        plotBorderWidth: 1, //null,
                        plotShadow: false
                    },
                    title: {
                        text: 'Damage details for ' + forUnit
                    },
					subtitle: {
						text: 'Combat: '+tm0+' - '+tm1
					},
                    tooltip: {
                        pointFormat: '{series.name}: <b>{point.percentage:.2f}%</b>'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: false,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '<b>{point.name}</b>: {point.percentage:.2f} %',
                                style: {
                                    color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                                }
                            }
                        }
                    },
                    series: []
                };

				var dmgseries = [];
				$.each(damages, function () {
					if (this[2] == forUnit) {
						var tmnow = parseFloat(this[1]);
						if (tm0 <= tmnow && tmnow <= tm1) {
							$.pieSeriesArrayAdd(dmgseries, this[4], parseFloat(this[5]));
						}
					}
				});
				$.sort2DArrayByIndex(dmgseries, 1);
				
				
				options.series.push({
					type: 'pie',
					name: 'Damage percent',
					data: dmgseries
				});
				
                $("#pieComparison").highcharts(options);
				$bodyroot.animate({
					scrollTop: $("#pieComparison").offset().top
				}, 500);
            }
        });
		
        $("#btnDamageTaken").click(function () {
            if (selectedCombat == "") {
                $.errMsg("Select a combat mate!");
            } else if (selectedSources.length != 1) {
                $.errMsg("Select one and only one source dude!");
            } else {
                var timeStamps = selectedCombat.split("-");		
                var tm0 = parseFloat(timeStamps[0]);
                var tm1 = parseFloat(timeStamps[1]);		
				var forUnit = selectedSources[0];

                // good to go!
                var options = {
                    chart: {
                        plotBackgroundColor: null,
                        plotBorderWidth: 1, //null,
                        plotShadow: false
                    },
                    title: {
                        text: 'Damage Taken details for ' + forUnit
                    },
					subtitle: {
						text: 'Combat: '+tm0+' - '+tm1
					},
                    tooltip: {
                        pointFormat: '{series.name}: <b>{point.percentage:.2f}%</b>'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: false,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '<b>{point.name}</b>: {point.percentage:.2f} %',
                                style: {
                                    color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                                }
                            }
                        }
                    },
                    series: []
                };

				var dmgseries = [];
				$.each(damages, function () {
					if (this[3] == forUnit) {
						var tmnow = parseFloat(this[1]);
						if (tm0 <= tmnow && tmnow <= tm1) {
							$.pieSeriesArrayAdd(dmgseries, this[4], parseFloat(this[5]));
						}
					}
				});
				$.sort2DArrayByIndex(dmgseries, 1);
				
				
				options.series.push({
					type: 'pie',
					name: 'Damage percent',
					data: dmgseries
				});
				
                $("#pieComparison").highcharts(options);
				$bodyroot.animate({
					scrollTop: $("#pieComparison").offset().top
				}, 500);
            }
        });
		
        $.accumulate2DArray3Var = function (arr, lab, eff, ovf) {			
			var found = 0;
			$.each(arr, function (i) {
				if (arr[i][0] == lab) {
					found = 1;
					arr[i][2] += eff;
					arr[i][3] += ovf;
					arr[i][1] += eff + ovf;
				}
			});
			if (found == 0) {
				arr.push([lab, eff+ovf, eff, ovf]);
			}
		}
		
		$("#btnHeal").click(function () {
            if (selectedCombat == "") {
                $.errMsg("Pick a combat first.");
            } else if (selectedSources.length != 1) {
                $.errMsg("You may pick one and only one source.");
            } else {
                var timeStamps = selectedCombat.split("-");		
                var tm0 = parseFloat(timeStamps[0]);
                var tm1 = parseFloat(timeStamps[1]);		
				var forUnit = selectedSources[0];								

                // data to build
				var colors = Highcharts.getOptions().colors;
				var categories = []; // 1d array names 'heal', 'rejuv', 'fastheal', 'flash'
				var name = 'Heal names';
				var data = []; /* elem = {
											y: 40, // main percentage
											color: colors[0], // fixed
											drilldown: {		// fixed
												name: 'heal effects',  // fixed
												categories: ['Effect', 'Overflow'],  // fixed
												data: [10, 30],   // small percentage, build up to main percentage
												color: colors[0]
											}
										 }*/
				
				var dataSeries = [];
				$.each(heals, function () {
					if (this[2] == forUnit) {
						var tmnow = parseFloat(this[1]);
						if (tm0 <= tmnow && tmnow <= tm1) {
							$.accumulate2DArray3Var(dataSeries, this[4], parseFloat(this[5]), parseFloat(this[6]));
						}
					}
				});
				$.sort2DArrayByIndex(dataSeries, 1);
				
				$.each(dataSeries, function(i) {
					categories.push(dataSeries[i][0]);
					data.push({
						y: dataSeries[i][1],
						color: colors[i],
						drilldown: {
							name: 'Heal effects',
							categories: [dataSeries[i][0]+' Effective', dataSeries[i][0]+' Overflow'],
							data: [dataSeries[i][2], dataSeries[i][3]],
							color: colors[i]
						}
					});
				});
						
				// Build the data arrays
				var browserData = [];
				var versionsData = [];
				for (var i = 0; i < data.length; i++) {			
					// add browser data
					browserData.push({
						name: categories[i],
						y: data[i].y,
						color: data[i].color
					});
			
					// add version data
					for (var j = 0; j < data[i].drilldown.data.length; j++) {
						var brightness = 0.2 - (j / data[i].drilldown.data.length) / 5 ;
						versionsData.push({
							name: data[i].drilldown.categories[j],
							y: data[i].drilldown.data[j],
							color: Highcharts.Color(data[i].color).brighten(brightness).get()
						});
					}
				}
				
				// build options of course
				var options = {
					chart: {
						type: 'pie'
					},
					title: {
						text: 'Healings done by ' + forUnit
					},
					subtitle: {
						text: 'Combat: '+tm0+' - '+tm1
					},
					yAxis: {
						title: {
							text: 'Total percent'
						}
					},
					plotOptions: {
						pie: {
							shadow: false,
							center: ['50%', '50%']
						}
					},
					tooltip: {
						pointFormat: '{series.name}: <b>{point.y:.2f}</b>'
//						valueSuffix: ''
					},
					series: [{
						name: 'Heals',
						data: browserData,
						size: '60%',
						dataLabels: {
							formatter: function() {
								var pct = this.point.percentage.toFixed(2)+"%";
								return this.point.percentage > 5 ? this.point.name+": "+pct : null;
							},
							color: 'white',
							distance: -30
						}
					}, {
						name: 'Points',
						data: versionsData,
						size: '80%',
						innerSize: '60%',
						dataLabels: {
							formatter: function() {
								// display only if larger than 1
								return this.y > 1 ? '<b>'+ this.point.name +':</b> '+ this.point.percentage.toFixed(2)+"%" : null;
							}
						}
					}]
				}
				
                $("#pieComparison").highcharts(options);
				$bodyroot.animate({
					scrollTop: $("#pieComparison").offset().top
				}, 500);
            }
        });
		
        $("#btnCast").click(function () {
            if (selectedCombat == "") {
                $.errMsg("A combat should be selected bro.");
            } else if (selectedSources.length != 1) {
                $.errMsg("Select one and only one source bro!");
            } else {
                var timeStamps = selectedCombat.split("-");		
                var tm0 = parseFloat(timeStamps[0]);
                var tm1 = parseFloat(timeStamps[1]);		
				var forUnit = selectedSources[0];

                // good to go!
                var options = {
                    chart: {
                        plotBackgroundColor: null,
                        plotBorderWidth: 1, //null,
                        plotShadow: false
                    },
                    title: {
                        text: 'Cast details for ' + forUnit
                    },
					subtitle: {
						text: 'Combat: '+tm0+' - '+tm1
					},
                    tooltip: {
                        pointFormat: '{series.name}: <b>{point.percentage:.2f}%</b>'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: false,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '<b>{point.name}</b>: {point.y:.0f}',
                                style: {
                                    color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                                }
                            }
                        }
                    },
                    series: []
                };

				var dmgseries = [];
				$.each(casts, function () {
					if (this[2] == forUnit) {
						var tmnow = parseFloat(this[1]);
						if (tm0 <= tmnow && tmnow <= tm1) {
							$.pieSeriesArrayAdd(dmgseries, this[4], 1.0);
						}
					}
				});
				$.sort2DArrayByIndex(dmgseries, 1);
				
				
				options.series.push({
					type: 'pie',
					name: 'Usage',
					data: dmgseries
				});
				
                $("#pieComparison").highcharts(options);
				$bodyroot.animate({
					scrollTop: $("#pieComparison").offset().top
				}, 500);
            }
        });
    </script>
</body>

</html>
